<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器 - 歌词同步</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #9b59b6;
            --background-dark: #121212;
            --card-dark: #1e1e1e;
            --text-light: #f5f5f5;
            --text-muted: #b3b3b3;
            --progress-bg: #333;
            --progress-fill: var(--primary-color);
            --error-color: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
        }

        .header-content {
            background: rgba(30, 30, 46, 0.7);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #8e44ad, #3498db);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 15px;
        }

        .player-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (min-width: 768px) {
            .player-container {
                flex-direction: row;
            }
        }

        .now-playing {
            flex: 1;
            background: linear-gradient(145deg, #1e1e2e, #252541);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            height: 750px;
            z-index: 1;
        }

        .now-playing::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(142, 68, 173, 0.1) 0%, transparent 70%);
            z-index: -1;
        }

        .playlist-container {
            flex: 1;
            background: linear-gradient(145deg, #1e1e2e, #252541);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-height: 750px;
            overflow-y: auto;
            position: relative;
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1/1;
            background: linear-gradient(135deg, #2c3e50, #4a235a, #3498db);
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .album-art i {
            font-size: 6rem;
            color: rgba(255, 255, 255, 0.15);
            transition: all 0.5s ease;
        }

        .playing .album-art i {
            animation: rotate 20s linear infinite;
        }

        /* 歌词显示样式 */
        .lyrics-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2;
            padding: 20px;
            box-sizing: border-box;
        }

        .current-lyric {
            color: white;
            font-size: 1.8rem;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
            line-height: 1.4;
            max-width: 90%;
        }

        .prev-lyric,
        .next-lyric {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.3rem;
            text-align: center;
            margin: 8px 0;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            max-width: 90%;
        }

        .no-lyrics {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            text-align: center;
            font-style: italic;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .track-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .track-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .track-artist {
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .progress-container {
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--progress-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
            cursor: pointer;
            position: relative;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            width: 0%;
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin: 30px 0;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.5rem;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .control-btn.play-pause {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            width: 70px;
            height: 70px;
            font-size: 2rem;
        }

        .control-btn.play-pause:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 6px 12px rgba(142, 68, 173, 0.4);
        }

        /* 播放模式按钮 */
        .control-btn.mode-btn {
            position: relative;
        }

        .mode-indicator {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--primary-color);
            color: white;
            font-size: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 20px;
            border-radius: 30px;
        }

        .volume-container i {
            color: var(--text-muted);
            font-size: 1.3rem;
        }

        .volume-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--progress-bg);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .playlist-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .playlist {
            list-style: none;
        }

        .playlist-item {
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item:hover {
            background: rgba(142, 68, 173, 0.15);
            transform: translateX(5px);
        }

        .playlist-item.playing {
            background: rgba(142, 68, 173, 0.25);
            border-left: 4px solid var(--primary-color);
        }

        .playlist-item i {
            color: var(--text-muted);
            font-size: 1.3rem;
            min-width: 24px;
            text-align: center;
        }

        .track-details {
            flex: 1;
            overflow: hidden;
        }

        .track-name {
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1.1rem;
        }

        .track-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.3;
                transform: scale(0.9);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0.3;
                transform: scale(0.9);
            }
        }

        .error {
            color: var(--error-color);
            text-align: center;
            padding: 25px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .error i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-muted);
            font-size: 0.95rem;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 自定义滚动条 */
        .playlist-container::-webkit-scrollbar {
            width: 8px;
        }

        .playlist-container::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 4px;
        }

        .playlist-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
        }

        /* 响应式调整 */
        @media (max-width: 767px) {
            h1 {
                font-size: 2rem;
            }

            .controls {
                gap: 15px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }

            .control-btn.play-pause {
                width: 65px;
                height: 65px;
                font-size: 1.8rem;
            }

            .album-art i {
                font-size: 5rem;
            }

            .current-lyric {
                font-size: 1.4rem;
            }

            .prev-lyric,
            .next-lyric {
                font-size: 1.1rem;
            }
        }

        /* 背景动画元素 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(142, 68, 173, 0.15) 0%, transparent 70%);
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            100% {
                transform: translate(100px, 100px) rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- 背景动画元素 -->
    <div class="bg-animation">
        <div class="circle" style="width: 300px; height: 300px; top: 10%; left: 5%; animation-duration: 20s;"></div>
        <div class="circle" style="width: 200px; height: 200px; top: 60%; left: 80%; animation-duration: 15s;"></div>
        <div class="circle" style="width: 150px; height: 150px; top: 30%; left: 50%; animation-duration: 25s;"></div>
    </div>

    <div class="container">
        <div class="player-container">
            <div class="now-playing">
                <div class="album-art">
                    <i class="fas fa-music" id="famusic"></i>
                    <!-- 歌词显示区域 <canvas id="visualizer" width="390" height="390"></canvas> <i class="fas fa-music"></canvas></i> -->
                    <div class="lyrics-container">
                        <div class="prev-lyric"></div>
                        <div class="current-lyric">选择歌曲开始播放</div>
                        <div class="next-lyric"></div>
                    </div>
                </div>

                <div class="track-info">
                    <h2 class="track-title">选择一首歌曲开始播放</h2>
                    <div class="track-artist" hidden>等待播放</div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="progress-time">
                        <span id="current-time">0:00</span>
                        <span id="total-time">0:00</span>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" id="prev-btn" title="上一曲">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause" id="play-pause-btn" title="播放">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="next-btn" title="下一曲">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <!-- 新增播放模式按钮 -->
                    <button class="control-btn mode-btn" id="mode-btn" title="顺序循环">
                        <i class="fas fa-repeat"></i>
                        <span class="mode-indicator">1</span>
                    </button>
                </div>

                <div class="volume-container">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="1" step="0.01"
                        value="0.7">
                </div>
            </div>

            <div class="playlist-container">
                <h2 class="playlist-title">
                    <i class="fas fa-list-music"></i>
                    播放列表
                </h2>
                <div class="loading" id="loading">
                    <i class="fas fa-compact-disc"></i>
                    <p>正在加载音乐列表...</p>
                </div>
                <ul class="playlist" id="playlist"></ul>
            </div>
        </div>

        <footer>
            <p>音乐播放器 &copy; 2025 | <a href="https://github.com/Jackarain/proxy"
                    style="text-decoration: none; color: inherit;">Jackarain</a></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // 创建音频上下文
            let audioContext = new (window.AudioContext || window.webkitAudioContext)()

            // 音频播放器
            const audioPlayer = new Audio();

            // 创建各结点
            let audioAnalyser, audioSource, dataArray;

            // 创建 source 结点
            audioSource = audioContext.createMediaElementSource(audioPlayer);
            // 创建 analyser 结点
            audioAnalyser = audioContext.createAnalyser();

            // 配置 analyser 结点的一些参数
            audioAnalyser.fftSize = 2048;
            const bufferLength = audioAnalyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            // 将源连接到 analyser 结点
            audioSource.connect(audioAnalyser);

            // 将 analyser 结点连接到 audioContext 的 destination, 即扬声器
            audioAnalyser.connect(audioContext.destination);

            let canvas = null;
            let canvasContext = null;

            // 获取DOM元素
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const volumeSlider = document.getElementById('volume-slider');
            const playlistEl = document.getElementById('playlist');
            const loadingEl = document.getElementById('loading');
            const trackTitle = document.querySelector('.track-title');
            const trackArtist = document.querySelector('.track-artist');
            const albumArt = document.querySelector('.album-art');
            const nowPlaying = document.querySelector('.now-playing');
            const modeBtn = document.getElementById('mode-btn');
            const modeIcon = modeBtn.querySelector('i');
            const modeIndicator = modeBtn.querySelector('.mode-indicator');

            // 歌词显示元素
            const currentLyricEl = document.querySelector('.current-lyric');
            const prevLyricEl = document.querySelector('.prev-lyric');
            const nextLyricEl = document.querySelector('.next-lyric');

            // 当前 URL
            const indexUrl = window.location.href;

            // 当前特效显示
            let currentVisualizer = 0;

            // 状态变量
            let currentTrackIndex = -1;
            let tracks = [];
            let isPlaying = false;
            let currentLyrics = []; // 当前歌词数组
            let currentLyricIndex = -1; // 当前歌词行索引

            // 播放模式 (0:顺序循环, 1:随机播放, 2:单曲循环)
            let playMode = 0;
            const playModes = [
                { name: "顺序循环", icon: "fas fa-repeat", indicator: "1" },
                { name: "随机播放", icon: "fas fa-random", indicator: "2" },
                { name: "单曲循环", icon: "fas fa-redo", indicator: "3" }
            ];

            ////////////////////////////////////////////////////////////////////////////////////////////////////
            /// 绘制可视化特效

            function changeVisualizer() {
                if (++currentVisualizer > 5)
                    currentVisualizer = 0;

                if (currentVisualizer === 0) {
                    const visualizer = document.getElementById('visualizer');
                    if (visualizer) {
                        visualizer.remove();

                        const musicIcon = document.createElement('i');
                        musicIcon.className = 'fas fa-music';
                        musicIcon.id = 'famusic';

                        albumArt.appendChild(musicIcon);
                    }
                } else {
                    const famusic = document.getElementById('famusic');
                    if (famusic) {
                        famusic.remove();

                        const visualizer = document.createElement('canvas');
                        visualizer.id = 'visualizer';
                        visualizer.style.cssText = `width: 390px; height: 390px;`;

                        albumArt.appendChild(visualizer);

                        canvas = document.getElementById('visualizer');
                        canvasContext = canvas.getContext('2d');

                        drawVisualization();
                    }
                }
            }

            // 用于存储特效所需的状态
            const visualizerStates = {
                particleSystem: [],
                rotationAngle: 0,
                peakHistory: new Array(60).fill(0) // 用于存储峰值历史
            };

            const visualizerFreq = [1, 2, 3, 4];

            function drawVisualization() {
                if (currentVisualizer === 0)
                    return;

                // 获取数据
                if (currentVisualizer in visualizerFreq) {
                    audioAnalyser.getByteFrequencyData(dataArray);
                } else {
                    audioAnalyser.getByteTimeDomainData(dataArray);
                }

                // 清空画布
                canvasContext.fillStyle = '#16213e';
                canvasContext.fillRect(0, 0, canvas.width, canvas.height);

                // 根据当前可视化模式调用不同的渲染函数
                switch (currentVisualizer) {
                    case 2:
                        drawCircularSpectrum(); // 圆形频谱
                        break;
                    case 3:
                        drawBarSpectrum();      // 柱状频谱
                        break;
                    case 4:
                        drawSpiralSpectrum();   // 螺旋频谱
                        break;
                    default:
                        drawBasicWaveform();    // 默认波形
                }

                // 下一帧
                requestAnimationFrame(drawVisualization);
            }

            // ====== 特效实现 ====== //
            function drawCircularSpectrum() {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.7;

                canvasContext.lineWidth = 2;
                canvasContext.strokeStyle = '#4cc9f0';
                canvasContext.beginPath();

                const bars = 180; // 显示180个频段
                const barAngle = (Math.PI * 2) / bars;

                for (let i = 0; i < bars; i++) {
                    // 获取频率数据（平均采样）
                    const idx = Math.floor(i * bufferLength / bars);
                    const value = dataArray[idx] / 256;

                    // 计算条形的长度（基于频率强度）
                    const barLength = value * radius * 0.8;

                    // 计算当前角度
                    const angle = i * barAngle + visualizerStates.rotationAngle;

                    // 计算起点和终点
                    const startX = centerX + Math.cos(angle) * radius;
                    const startY = centerY + Math.sin(angle) * radius;
                    const endX = centerX + Math.cos(angle) * (radius + barLength);
                    const endY = centerY + Math.sin(angle) * (radius + barLength);

                    // 创建渐变
                    const gradient = canvasContext.createLinearGradient(startX, startY, endX, endY);
                    gradient.addColorStop(0, '#4cc9f0');
                    gradient.addColorStop(1, '#f72585');

                    canvasContext.strokeStyle = gradient;
                    canvasContext.beginPath();
                    canvasContext.moveTo(startX, startY);
                    canvasContext.lineTo(endX, endY);
                    canvasContext.stroke();
                }

                // 缓慢旋转
                visualizerStates.rotationAngle += 0.002;
            }

            function drawBarSpectrum() {
                const originalBufferLength = bufferLength;
                const eightyPercentLength = Math.floor(originalBufferLength * 0.8);

                const truncatedDataArray = new Uint8Array(eightyPercentLength);
                for (let i = 0; i < eightyPercentLength; i++) {
                    truncatedDataArray[i] = dataArray[i];
                }

                const resampledDataArray = new Uint8Array(originalBufferLength);

                for (let i = 0; i < originalBufferLength; i++) {
                    const sourceIndex = (i / originalBufferLength) * eightyPercentLength;

                    const index1 = Math.floor(sourceIndex);
                    const index2 = Math.min(Math.ceil(sourceIndex), eightyPercentLength - 1);

                    const value1 = truncatedDataArray[index1];
                    const value2 = truncatedDataArray[index2];

                    const weight = sourceIndex - index1;
                    resampledDataArray[i] = Math.round(value1 * (1 - weight) + value2 * weight);
                }

                const bufferWidth = bufferLength;
                const barWidth = (canvas.width / bufferWidth);
                canvasContext.fillStyle = '#000';
                canvasContext.fillRect(0, 0, canvas.width, canvas.height);

                for (let i = 0; i < bufferWidth; i++) {
                    const weightingFactor = (i / bufferWidth) * 1.0 + 0.7;

                    let barHeight = resampledDataArray[i] * (canvas.height / 256);
                    barHeight *= weightingFactor; // Apply the weighting

                    const hue = i * 360 / bufferWidth;

                    canvasContext.fillStyle = `hsl(${hue}, 100%, 60%)`;
                    canvasContext.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
                }
            }

            function drawSpiralSpectrum() {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;

                canvasContext.lineWidth = 3;
                canvasContext.beginPath();

                const spiralTurns = 3;
                const maxRadius = Math.min(centerX, centerY) * 0.8;
                const startRadius = maxRadius * 0.2;

                for (let i = 0; i < bufferLength; i++) {
                    // 计算当前点在螺旋上的位置
                    const progress = i / bufferLength;
                    const angle = progress * Math.PI * 2 * spiralTurns + visualizerStates.rotationAngle;
                    const radius = startRadius + progress * (maxRadius - startRadius);

                    // 获取频率值
                    const value = dataArray[i] / 256;

                    // 计算偏移量（基于频率强度）
                    const offset = value * maxRadius * 0.3;

                    // 计算实际坐标
                    const x = centerX + Math.cos(angle) * (radius + offset);
                    const y = centerY + Math.sin(angle) * (radius + offset);

                    if (i === 0) {
                        canvasContext.moveTo(x, y);
                    } else {
                        canvasContext.lineTo(x, y);
                    }
                }

                // 创建渐变描边
                const gradient = canvasContext.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#4cc9f0');
                gradient.addColorStop(0.5, '#7209b7');
                gradient.addColorStop(1, '#f72585');

                canvasContext.strokeStyle = gradient;
                canvasContext.stroke();

                // 旋转效果
                visualizerStates.rotationAngle += 0.01;
            }

            // 基础波形, 包括时域和频率2种波形
            function drawBasicWaveform() {
                canvasContext.lineWidth = 1;
                canvasContext.strokeStyle = '#4cc9f0';
                canvasContext.beginPath();

                const sliceWidth = canvas.width / bufferLength;
                let x = 0;
                let y = 0;
                let v = 0;

                for (let i = 0; i < bufferLength; i++) {
                    v = dataArray[i] / 128.0;

                    if (currentVisualizer === 1) {
                        y = canvas.height - (v * canvas.height / 3);
                    } else {
                        y = v * canvas.height / 2;
                    }

                    if (i === 0)
                        canvasContext.moveTo(x, y);
                    else
                        canvasContext.lineTo(x, y);

                    x += sliceWidth;
                }

                if (currentVisualizer !== 1)
                    canvasContext.lineTo(canvas.width, canvas.height / 2);

                canvasContext.stroke();
            }

            ////////////////////////////////////////////////////////////////////////////////////////////////////

            // 修复URL构建问题
            function getJsonUrl() {
                const currentUrl = new URL(indexUrl);

                // 移除文件名部分（如果有）
                let path = currentUrl.pathname;
                if (path.endsWith('.html')) {
                    path = path.substring(0, path.lastIndexOf('/') + 1);
                }

                // 确保路径以斜杠结尾
                if (!path.endsWith('/')) {
                    path += '/';
                }

                // 构建新的URL
                currentUrl.pathname = path;
                currentUrl.search = '?q=json';

                return currentUrl.toString();
            }

            // 获取歌词目录的JSON URL
            function getLyricsJsonUrl() {
                const currentUrl = new URL(indexUrl);
                let path = currentUrl.pathname;

                if (path.endsWith('.html')) {
                    path = path.substring(0, path.lastIndexOf('/') + 1);
                }

                if (!path.endsWith('/')) {
                    path += '/';
                }

                // 添加lyrics目录
                path += 'lyrics/';

                currentUrl.pathname = path;
                currentUrl.search = '?q=json';

                return currentUrl.toString();
            }

            // 加载音乐列表
            async function loadPlaylist() {
                try {
                    const jsonUrl = getJsonUrl();
                    console.log("加载音乐文件 JSON URL:", jsonUrl);

                    const response = await fetch(jsonUrl);

                    if (!response.ok) {
                        throw new Error(`网络响应错误: ${response.status}`);
                    }

                    // 检查内容类型
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        throw new Error(`响应不是JSON格式: ${text.substring(0, 100)}`);
                    }

                    const data = await response.json();

                    // 过滤音乐文件
                    const musicExtensions = ['.mp3', '.m4a', '.ogg', '.wav', '.flac', '.aac'];
                    tracks = data.filter(item =>
                        !item.is_dir &&
                        !item.filename.endsWith('.html') &&
                        musicExtensions.some(ext => item.filename.toLowerCase().endsWith(ext))
                    );

                    if (tracks.length === 0) {
                        throw new Error('该目录中没有找到音乐文件');
                    }

                    tracks.sort((a, b) => {
                        // 判断是否为英文文件名（仅包含 ASCII 字符）
                        const isEnglishA = /^[\x00-\x7F]*$/.test(a.filename);
                        const isEnglishB = /^[\x00-\x7F]*$/.test(b.filename);

                        // 如果一个是英文，一个是中文，英文排前面
                        if (isEnglishA && !isEnglishB) return -1;
                        if (!isEnglishA && isEnglishB) return 1;

                        // 两者都是英文或都是中文，按升序排序
                        return a.filename.localeCompare(b.filename, 'zh-CN');
                    });

                    renderPlaylist();
                    loadingEl.style.display = 'none';

                } catch (error) {
                    console.error('加载播放列表失败:', error);
                    loadingEl.innerHTML = `<div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>加载音乐列表失败</p>
                        <p>${error.message}</p>
                        <p style="margin-top: 15px; font-size: 0.9rem;">请检查URL是否正确或服务器是否正常运行</p>
                    </div>`;
                }
            }

            // 渲染播放列表
            function renderPlaylist() {
                playlistEl.innerHTML = '';

                tracks.forEach((track, index) => {
                    const li = document.createElement('li');
                    li.className = 'playlist-item';
                    if (index === currentTrackIndex) {
                        li.classList.add('playing');
                    }

                    li.innerHTML = `
                        <i class="fas fa-music"></i>
                        <div class="track-details">
                            <div class="track-name">${track.filename}</div>
                            <div class="track-meta">
                                <span>${formatFileSize(track.filesize)}</span>
                                <span>${track.last_write_time}</span>
                            </div>
                        </div>
                    `;

                    li.addEventListener('click', () => playTrack(index));
                    playlistEl.appendChild(li);
                });
            }

            function onPlayed() {
                isPlaying = true;

                updatePlayButton();

                // 添加播放状态类
                nowPlaying.classList.add('playing');
                albumArt.classList.add('playing');

                // 高亮当前播放项
                renderPlaylist();

                // 绘制可视化效果
                drawVisualization();

                // 设置播放结束事件
                audioPlayer.onended = playNext;
            }

            // 播放指定曲目
            async function playTrack(index) {
                if (index < 0 || index >= tracks.length) return;

                currentTrackIndex = index;
                const track = tracks[currentTrackIndex];

                // 构建音乐文件URL
                const musicUrl = getMusicUrl(track.filename);

                audioPlayer.crossOrigin = 'anonymous';

                // 打开 musicUrl
                audioPlayer.src = musicUrl;

                // 更新UI
                trackTitle.textContent = track.filename.split('.').slice(0, -1).join('.');
                trackArtist.textContent = formatFileSize(track.filesize);

                // 重置歌词显示
                resetLyricsDisplay();

                // 加载歌词
                await loadLyrics(track.filename);

                // 播放音乐
                audioPlay();
            }

            async function loadLyrics(filename) {
                const baseName = filename.split('.').slice(0, -1).join('.');
                const lrcFilename = `${baseName}.lrc`;
                const subdirs = ['lyrics/', ''];

                for (const subdir of subdirs) {
                    try {
                        const lyricsUrl = getLyricsUrl(lrcFilename, subdir);
                        const response = await fetch(lyricsUrl);

                        if (!response.ok) {
                            continue; // 直接尝试下一个路径
                        }

                        const text = await response.text();
                        currentLyrics = parseLyrics(text);
                        currentLyricIndex = -1;
                        // 清空歌词区
                        currentLyricEl.textContent = '';
                        // 更新歌词显示
                        updateLyricsDisplay();
                        return; // 成功加载后退出
                    } catch (error) {
                        console.error(`加载歌词失败 (${subdir}${lrcFilename}):`, error);
                    }
                }

                // 所有路径都失败时的默认处理
                currentLyrics = [];
                currentLyricIndex = -1;
                currentLyricEl.textContent = '未找到歌词';
                prevLyricEl.textContent = '';
                nextLyricEl.textContent = '';
            }

            // 解析歌词
            function parseLyrics(text) {
                text = text.replace(/<\d{2}:\d{2}\.\d{2,3}>/g, '');
                const lines = text.split('\n');
                const lyrics = [];

                // 正则匹配歌词时间标签
                const regex = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;

                lines.forEach(line => {
                    const match = line.match(regex);
                    if (match) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const milliseconds = parseInt(match[3]) / (match[3].length === 2 ? 100 : 1000);
                        const time = minutes * 60 + seconds + milliseconds;
                        const text = match[4].trim();

                        if (text) {
                            lyrics.push({ time, text });
                        }
                    }
                });

                // 按时间排序
                lyrics.sort((a, b) => a.time - b.time);
                return lyrics;
            }

            // 更新歌词显示
            function updateLyricsDisplay() {
                const currentTime = audioPlayer.currentTime;

                // 如果没有歌词
                if (currentLyrics.length === 0) {
                    // currentLyricEl.textContent = '未找到歌词';
                    prevLyricEl.textContent = '';
                    nextLyricEl.textContent = '';
                    return;
                }

                // 查找当前歌词行
                let newIndex = -1;

                // 找到最后一个时间小于当前时间的歌词行
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentTime >= currentLyrics[i].time) {
                        newIndex = i;
                    } else {
                        break;
                    }
                }

                // 如果歌词行发生变化
                if (newIndex !== currentLyricIndex) {
                    currentLyricIndex = newIndex;

                    // 更新歌词显示
                    if (currentLyricIndex >= 0) {
                        currentLyricEl.textContent = currentLyrics[currentLyricIndex].text;
                    } else {
                        currentLyricEl.textContent = '';
                    }

                    // 显示上一行歌词
                    if (currentLyricIndex > 0) {
                        prevLyricEl.textContent = currentLyrics[currentLyricIndex - 1].text;
                    } else {
                        prevLyricEl.textContent = '';
                    }

                    // 显示下一行歌词
                    if (currentLyricIndex < currentLyrics.length - 1) {
                        nextLyricEl.textContent = currentLyrics[currentLyricIndex + 1].text;
                    } else {
                        nextLyricEl.textContent = '';
                    }
                }
            }

            // 重置歌词显示
            function resetLyricsDisplay() {
                currentLyrics = [];
                currentLyricIndex = -1;
                currentLyricEl.textContent = '加载歌词中...';
                prevLyricEl.textContent = '';
                nextLyricEl.textContent = '';
            }

            // 获取音乐文件的完整URL
            function getMusicUrl(filename) {
                const currentUrl = new URL(indexUrl);
                let path = currentUrl.pathname;

                // 移除文件名部分（如果有）
                if (path.endsWith('.html')) {
                    path = path.substring(0, path.lastIndexOf('/') + 1);
                }

                // 确保路径以斜杠结尾
                if (!path.endsWith('/')) {
                    path += '/';
                }

                currentUrl.pathname = path + filename;
                return currentUrl.toString();
            }

            // 获取歌词文件的完整URL
            function getLyricsUrl(filename, subdir) {
                const currentUrl = new URL(indexUrl);
                let path = currentUrl.pathname;

                // 移除文件名部分（如果有）
                if (path.endsWith('.html')) {
                    path = path.substring(0, path.lastIndexOf('/') + 1);
                }

                // 确保路径以斜杠结尾
                if (!path.endsWith('/')) {
                    path += '/';
                }

                // 添加lyrics目录
                path += subdir + filename;

                currentUrl.pathname = path;
                return currentUrl.toString();
            }

            // 播放/暂停控制
            async function togglePlay() {
                if (currentTrackIndex === -1 && tracks.length > 0) {
                    playTrack(0);
                    return;
                }

                if (isPlaying) {
                    audioPlayer.pause();
                    isPlaying = false;
                    nowPlaying.classList.remove('playing');
                    albumArt.classList.remove('playing');
                } else {
                    audioPlay();
                    nowPlaying.classList.add('playing');
                    albumArt.classList.add('playing');
                }
                updatePlayButton();
            }

            // 调用播放.
            async function audioPlay() {
                try {
                    // 恢复挂起的音频上下文
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    audioPlayer.play();
                    onPlayed();
                } catch (error) {
                    console.log(error);
                    // Autoplay was prevented.
                    // Show a "Play" button so that user can start playback.
                }
            }

            // 更新播放按钮图标
            function updatePlayButton() {
                const icon = playPauseBtn.querySelector('i');
                icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            }

            // 播放上一曲
            function playPrev() {
                if (tracks.length === 0) return;

                let newIndex = currentTrackIndex - 1;
                if (newIndex < 0) {
                    newIndex = tracks.length - 1; // 循环到最后一首
                }
                playTrack(newIndex);
            }

            // 播放下一曲
            function playNext() {
                if (tracks.length === 0) return;

                let newIndex;

                switch (playMode) {
                    case 0: // 顺序循环
                        newIndex = currentTrackIndex + 1;
                        if (newIndex >= tracks.length) {
                            newIndex = 0;
                        }
                        break;
                    case 1: // 随机播放
                        // 确保不会连续播放同一首歌（当有多首歌时）
                        do {
                            newIndex = Math.floor(Math.random() * tracks.length);
                        } while (tracks.length > 1 && newIndex === currentTrackIndex);
                        break;
                    case 2: // 单曲循环
                        newIndex = currentTrackIndex;
                        break;
                }

                playTrack(newIndex);
            }

            // 切换播放模式
            function togglePlayMode() {
                playMode = (playMode + 1) % 3;
                updateModeButton();
            }

            // 更新播放模式按钮
            function updateModeButton() {
                const mode = playModes[playMode];
                modeBtn.title = mode.name;
                modeIcon.className = mode.icon;
                modeIndicator.textContent = mode.indicator;
            }

            // 更新进度条
            function updateProgress() {
                const { currentTime, duration } = audioPlayer;
                const progressPercent = (currentTime / duration) * 100;
                progress.style.width = `${progressPercent}%`;

                currentTimeEl.textContent = formatTime(currentTime);
                totalTimeEl.textContent = formatTime(duration);

                // 更新歌词显示
                updateLyricsDisplay();
            }

            // 设置进度
            function setProgress(e) {
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;

                audioPlayer.currentTime = (clickX / width) * duration;
            }

            // 设置音量
            function setVolume() {
                audioPlayer.volume = volumeSlider.value;

                // 更新音量图标
                const volumeIcon = document.querySelector('.volume-container i');
                if (volumeSlider.value == 0) {
                    volumeIcon.className = 'fas fa-volume-mute';
                } else if (volumeSlider.value < 0.5) {
                    volumeIcon.className = 'fas fa-volume-down';
                } else {
                    volumeIcon.className = 'fas fa-volume-up';
                }
            }

            // 工具函数：格式化时间
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';

                const minutes = Math.floor(seconds / 60);
                seconds = Math.floor(seconds % 60);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }

            // 工具函数：格式化文件大小
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }

            // 事件监听
            playPauseBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrev);
            nextBtn.addEventListener('click', playNext);
            modeBtn.addEventListener('click', togglePlayMode);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            progressBar.addEventListener('click', setProgress);
            volumeSlider.addEventListener('input', setVolume);
            albumArt.addEventListener('click', changeVisualizer);

            audioPlayer.addEventListener('loadeddata', () => console.log('音频加载成功'));
            audioPlayer.addEventListener('error', () => console.error('音频加载失败:', audioPlayer.error));

            // 初始化
            loadPlaylist();
            updateModeButton(); // 初始化模式按钮
        });
    </script>
</body>

</html>